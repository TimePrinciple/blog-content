---
# Must present
author: Ruoqing He
title: Basics
# Optional
date: 2024-03-13
summary: Basic knowledge for interview.
---

## 计算机网络

### 网络层

网络层实现主机之间的通信，链路层实现具体每段链路之间的通信。因此在通信过程中，IP数据报的源地址和目的地址（IP地址）始终不变，而MAC地址随着链路的改变而改变（具体的设备上的通信网卡）。

#### IP数据报格式

- 源IP地址
- 目的IP地址
- 版本：IPv4 或 IPv6
- 首部长度
- 总长度
- 生存时间：TTL，防止无法交付的数据报在互联网中占用资源。以路由器跳数为单位，当TTL为0时丢弃数据报
- 协议：TCP，UDP，ICMP，IGMP，ARP，RARP
- 首部校验和：每经由一个路由器都需要重新计算校验和
- 标识：分片情况下，相同数据报的不同分片具有相同的标识符
- 片偏移：分片情况下启用，单位为8字节

#### IP地址编址方式

1. 分类：ABCDE类
2. 子网划分
3. 无分类：CIDR

#### ARP地址解析协议

ARP实现由IP地址得到MAC地址。

每个主机都有一个ARP高速缓存，里面有本局域网上的各主机和路由器的IP地址到MAC地址的映射表。如果对方的MAC地址未知（也不在高速缓存内），该主机通过广播方式发送ARP请求分组，对方主机收到该请求后会发送ARP响应分组给该主机，告知其MAC地址，随后该主机会将该映射写入高速缓存。

#### ICMP网际控制报文协议

ICMP是为更有效地转发IP数据报和提高交付成功的机会。被封装在IP数据报中，但不属于高层协议。

ICMP分为：
- 差错报告报文：
  1. 3：终点不可达
  2. 11：超时
  3. 12：参数问题
  4. 5：改变路由（Redirect）
- 询问报文：
  1. 0或8：Echo回答或请求
  2. 13或14：Timestamp请求或回答

Ping: 是ICMP的一个重要应用，主要用来来测试两台主机之间的连通性。原理是通过向目的主机发送ICMP Echo请求报文，目的主机收到之后发回Echo回答报文。Ping会根据时间和成功响应的次数估算出数据报往返时间以及丢包率。

#### 路由器的结构

功能划分：路由选择，分组转发

分组转发由：
- 交换结构
- 输入端口
- 输出端口

其中，这些端口都为队列，当队满时到达的报文会被丢弃，出现丢包的现象。

### 传输层

#### UDP用户数据报协议

UDP是[无连接的，尽最大可能交付，无拥塞控制，面向报文，支持一对一，一对多，多对一，多对多的]的通信协议。

##### 首部格式

首部字段一共 8 个字节，包括：
- 源端口
- 目的端口
- 长度
- 校验和

#### TCP传输控制协议

TCP是[面向连接的，提供可靠交付，有流量控制，拥塞控制，提供全双工通信，面向字节流，一对一]的通信协议。

##### 首部格式

首部字段包括：
- 源端口
- 目的端口
- 序号：[seq]
- 确认号: [ack]
- 数据偏移：也为首部长度
- ACK确认：TCP规定，连接建立后的所有报文段ACK置1
- SYN同步：当`SYN=1, ACK=0`表示这是一个请求报文段。若对方同意建立连接，响应报文`SYN=1, ACK=1`
- FIN终止：表示报文段的发送方数据已经发送完毕，并要求释放连接

##### 三次握手

1. Client发送`SYN=1，seq=x`给服务端，进入`SYN-SENT`状态。
2. Server收到后，发回`SYN=1, ACK=1, seq=y, ack=x+1`，由`LISTEN`进入`SYN-RECEIVED`状态。
3. Client收到后，发回`ACK=1, seq=x+1, ack=y+1`，由`SYN-SENT`进入`ESTABLISHED`状态。
4. Server收到后，进入`ESTABLISHED`状态。
5. 开始数据传输。

###### 原因

第三次握手是为了防止失效的连接请求到达服务器，让服务器错误地打开连接。

客户端发送的连接请求如果在网络中滞留，那么会导致隔很长一段时间才能收到服务端发回的连接确认。客户端等待一个超时重传的时间后，就会重新请求连接。但先前滞留的连接请求最后还是会到达服务器，如果不进行三次握手，那么服务器会打开两个连接。如果有第三次握手，客户端会忽略服务器之后发送的对滞留连接请求的连接确认，不进行第三次握手，因而不会再次打开连接。

##### 四次挥手

1. Client发送`FIN=1, seq=u`，由`ESTABLISHED`进入`FIN-WAIT-1`状态。
2. Server收到后，发回`ACK=1, seq=v, ack=u+1`，由`ESTABLISHED`进入`CLOSE-WAIT`状态。
3. Client收到后，由`FIN-WAIT-1`进入`FIN-WAIT-2`状态，Server继续发送数据。
4. Server完成数据发送，发送`FIN=1, ACK=1, seq=w, ack=u+1`，由`CLOSE-WAIT`进入`LAST-ACK`状态。
5. Client收到后，发回`ACK=1, seq=u+1, ack=w+1`，由`FIN-WAIT-2`进入`TIME-WAIT`状态。
6. Server收到后，进入`CLOSED`状态。
7. Client在2MSL之后，进入`CLOSED`状态。

###### 原因

客户端发送了FIN连接释放报之后，服务端收到了这个报文，就进入了`CLOSE-WAIT`状态。这个状态是为了让服务器端发送还未传送完毕的数据，传送完毕之后，服务器会发送FIN连接释放报文。

###### TIME-WAIT

客户端接收到服务端的FIN报文之后进入此状态，需要等待2MSL的时间：
- 确保最后一个确认报文能够到达。如果服务端没有收到客户端的确认报文，那么就会重新发送连接释放报文给客户端，为处理这种情况所以需要等待。
- 等待一段时间是为让本连接持续时间内所产生的所有报文都从网络中消失，使得下一个新的连接不会出现旧的连接请求。

###### `tcp_orphan_retries`

在`/proc/sys/net/ipv4/tcp_orphan_retires`内，内核默认参数为0（但指代的是8次），在`LAST_ACK`阶段若迟迟收不到来自Client的ACK，至多8次重试后会直接关闭该连接。